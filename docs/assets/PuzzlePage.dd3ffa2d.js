var B=Object.defineProperty;var N=(i,t,s)=>t in i?B(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var p=(i,t,s)=>(N(i,typeof t!="symbol"?t+"":t,s),s);import{_ as R,l as A,T as y,o as u,c as f,a as P,b as C,w as c,n as _,F as E,r as W,d as H,e as S,u as $,f as I,g as x,h as M,i as G}from"./index.eec665f4.js";const d=0;class F{constructor(t){p(this,"dx");p(this,"dy");p(this,"blocks");p(this,"blankpos");if(this.dy=t.length,this.dx=t[0].length,this.dy<2||this.dx<2)throw new Error("cannot initialize with the array which has less than 2 col/rows");this.blocks=new Array(this.dx*this.dy);let s=0;for(let e=0;e<this.dy;e++)for(let o=0;o<this.dx;o++)this.blocks[s]=t[e][o],t[e][o]===d&&(this.blankpos=s),s++}row(t){return Math.floor(t/this.dx)}col(t){return t%this.dx}dimensions(){return{x:this.dx,y:this.dy}}checkInRange(...t){for(let s of t)if(this.blocks[s]==null)throw new Error(`Index ${s} not in range [0 .. ${this.blocks.length-1}]`)}direction(t,s){if(this.checkInRange(t,s),this.row(s)===this.row(t)){if(s%this.dx===t%this.dx-1)return"Left";if(s%this.dx===t%this.dx+1)return"Right"}return s===t+this.dx?"Below":s===t-this.dx?"Above":null}hamming(){let t=0;for(let s=0,e=1,o=this.blocks.length;s<o;s++,e++)this.blocks[s]!==d&&this.blocks[s]!==e&&t++;return t}manhattan(){let t=0;for(let s=0,e=this.blocks.length;s<e;s++){if(this.blocks[s]===d)continue;const o=Math.abs(this.row(this.blocks[s]-1)-this.row(s)),n=Math.abs(this.col(this.blocks[s]-1)-this.col(s));t+=o+n}return t}isGoal(){for(let t=0,s=this.blocks.length;t<s;t++)if(this.blocks[t]!==d&&this.blocks[t]!==t+1)return!1;return!0}swap(t,s,e){if(this.checkInRange(s,e),this.blocks[s]!==d&&this.blocks[e]!==d)throw new Error("cannot swap non-space block");return[t[s],t[e]]=[t[e],t[s]],this.blankpos=t[s]===d?s:e,this}swapAbove(t){return this.swap(this.blocks,t,t-this.dx)}swapBelow(t){return this.swap(this.blocks,t,t+this.dx)}swapLeft(t){return this.swap(this.blocks,t,t-1)}swapRight(t){return this.swap(this.blocks,t,t+1)}slide(t){switch(this.checkInRange(t),this.direction(t,this.blankpos||0)){case"Above":return this.swapAbove(t);case"Below":return this.swapBelow(t);case"Left":return this.swapLeft(t);case"Right":return this.swapRight(t);default:return this}}toArray2D(){let t=0;const s=[];for(let e=0;e<this.dy;e++){const o=[];for(let n=0;n<this.dx;n++,t++)o.push(this.blocks[t]);s.push(o)}return s}}const L=(i,t)=>{const s=[];let e=0;for(let o=0;o<t;o++){const n=[];for(let h=0;h<i;h++)n.push(++e%(i*t));s.push(n)}return s},T=(i,t)=>{const s=L(i,t),e=new F(s),o=["swapAbove","swapLeft","swapRight","swapBelow"],n=o.length;for(let h=0;h<100;h++){const a=o[Math.floor(Math.random()*n)];try{e[a](e.blankpos)}catch{continue}}return e},V={name:"PuzzleBoard",data(){this._blockPositions=[],this._isStarted=!1;const i=T(this.cols,this.rows);return{isTouchNeeded:!0,blocks:i.blocks,isGoal:!1,manhattan:null,hamming:null,internalWidth:this.width,internalHeight:this.height,board:i,rafId:null,_tmpCtx:void 0,_tmpCanvas:void 0}},props:{src:{type:String},sources:{type:Array},muted:{type:Boolean,default:!0},animation:{type:Boolean,default:!0},cols:{type:Number,default:4},width:{type:Number,default:300},height:{type:Number,default:300},rows:{type:Number,default:4},showNumber:{type:Boolean,default:!0},autoResize:{type:Boolean,default:!1}},computed:{cellWidth(){return this.internalWidth/this.cols},cellHeight(){return this.internalHeight/this.rows},isImage(){return/\.(jpe?g|png|webm|gif)$/i.test(this.src)},canvasStyle(){return{left:this.isGoal?"-100%":0}},sourceStyle(){const i={};return this.isGoal||(i.visibility="hidden"),i}},beforeDestroy(){this.rafId&&cancelAnimationFrame(this.rafId)},mounted(){this.onResize(),window.addEventListener("resize",A(this.onResize.bind(this),300)),this._tmpCanvas=this.$refs["puzzle-canvas1"],this._tmpCtx=this._tmpCanvas.getContext("2d"),this._lastRenderVideoTime=-1,this._lastRenderTime=0,this.isImage?this.$nextTick(()=>{this._loadImageToCanvas(),this.$refs.sourceImg.addEventListener("load",()=>{this.isTouchNeeded=!1,console.log("image loaded"),this._loadImageToCanvas()})}):this.$nextTick(()=>{this.$refs.sourceImg.addEventListener("load",()=>{this.isTouchNeeded=!1,console.log("image loaded")})});const i=()=>{if(y.update(),this.$refs.sourceImg==null||this.$refs.sourceImg.readyState<3){requestAnimationFrame(i);return}const t=this.$refs.sourceImg,s=this.$refs["puzzle-canvas"],e=s.getContext("2d"),o=this.internalWidth;if(t.currentTime!==this._lastRender&&(this._lastRenderVideoTime=t.currentTime,this._loadVideoFrameToCanvas()),this.isGoal){requestAnimationFrame(i);return}e.clearRect(0,0,this.internalWidth,this.internalHeight),this.showNumber&&(e.font="24px 'Avenir', Helvetica, Arial, sans-serif",e.fillStyle="#ffffff",e.textBaseline="top");for(let n=0,h=this.blocks.length;n<h;n++){const a=this.blocks[n];if(a===0)continue;const l=this.board.row(a-1),r=this.board.col(a-1),k=this.cellWidth*r+o,v=this.cellHeight*l,g=this._blockPositions[a];if(g==null)continue;const m=g.x,w=g.y;if(e.drawImage(s,k,v,this.cellWidth,this.cellHeight,m,w,this.cellWidth,this.cellHeight),this.showNumber){const z=String(a),b=5;e.strokeText(z,b+m,b+w),e.fillText(z,b+m,b+w)}}this.rafId=requestAnimationFrame(i)};this.$nextTick(i),this.$emit("init")},watch:{cols(){this.initBoard()},rows(){this.initBoard()},board(){this.blocks=this.board.blocks},width(){this.onResize()},height(){this.onResize()},blocks(){const i=!this.animation;this.updateBlockPositions(i),this.isGoal=this.board.isGoal(),this.manhattan=this.board.manhattan(),this.hamming=this.board.hamming(),this.$emit("change",{blocks:this.blocks,isGoal:this.isGoal,distance:this.manhattan})},isGoal(){this.isGoal&&this.$emit("finish")},sources(){this.isImage||this.$nextTick(()=>{this.$refs.sourceImg.load(),this.isTouchNeeded=!0,this.$refs.sourceImg.play(),this.$refs.sourceImg.addEventListener("play",()=>{this.isTouchNeeded=!1})})},src(){this.isImage&&(this.isTouchNeeded=!1,this._loadImageToCanvas(),this.$nextTick(()=>{this.$refs.sourceImg.addEventListener("load",()=>{console.log("image loaded"),this._loadImageToCanvas()})}))}},methods:{initBoard(){this.board=T(this.cols,this.rows),this._blockPositions=[],this._isStarted=!1,this.$emit("init")},updateBlockPositions(i){for(let t=0,s=this.blocks.length;t<s;t++){const e=this.blocks[t],o=this.board.col(t),n=this.board.row(t),h=this.cellWidth*o,a=this.cellHeight*n,l=this._blockPositions[e]||{x:0,y:0};if(this._blockPositions[e]==null&&(this._blockPositions[e]=l),l.x-h===0&&l.y-a===0)continue;const r={x:l.x,y:l.y};i?(this._blockPositions[e].x=h,this._blockPositions[e].y=a):new y.Tween(r).to({x:h,y:a},200).easing(y.Easing.Quadratic.Out).onUpdate(()=>{this._blockPositions[e].x=r.x,this._blockPositions[e].y=r.y}).start()}},_loadImageToCanvas(){const i=this.$refs.sourceImg;if(i.width===0||i.height===0)return;const s=this.$refs["puzzle-canvas"].getContext("2d"),e=this.width,o=this.height,n=i.width,h=i.height,a=Math.max(e/n,o/h);console.log("ratio",a),this._tmpCanvas.width=n*a,this._tmpCanvas.height=h*a,console.log("tmpCtx",i,0,0,n*a,h*a),this._tmpCtx.drawImage(i,0,0,n*a,h*a);const l=(n*a-e)/2||0,r=(h*a-o)/2||0;console.log("_loadImageToCanvas -> ctx.drawImage",{marginX:l,marginY:r,w:e,h:o}),console.log(this._tmpCanvas,l,r,e,o,e,0,e,o),s.drawImage(this._tmpCanvas,l,r,e,o,e,0,e,o)},_loadVideoFrameToCanvas(){const i=this.$refs.sourceImg,s=this.$refs["puzzle-canvas"].getContext("2d"),e=this.internalWidth,o=this.internalHeight,n=i.videoWidth,h=i.videoHeight,a=Math.max(e/n,o/h);this._tmpCanvas.width=n*a,this._tmpCanvas.height=h*a,this._tmpCtx.drawImage(i,0,0,n*a,h*a);const l=(n*a-e)/2,r=(h*a-o)/2;console.log("_loadVideoFrameToCanvas -> ctx.drawImage",{marginX:l,marginY:r,w:e,h:o}),s.drawImage(this._tmpCanvas,l,r,e,o,e,0,e,o)},slide(i){this._isStarted||(this._isStarted=!0,this.$emit("start")),this.board.slide(i),this.blocks=this.board.blocks.concat()},onTouchEnd(i){this.isTouchNeeded&&this.$refs.sourceImg.play();const t=i.changedTouches[0],s=this.$el.getBoundingClientRect(),e=t.clientX-s.left,o=t.clientY-s.top;this.handleClick(e,o)},onClick(i){const t=i.offsetX-(this.isGoal?this.width:0),s=i.offsetY;this.handleClick(t,s)},handleClick(i,t){i=i/this.cellWidth,t=t/this.cellHeight;const s=Math.floor(i),o=Math.floor(t)*this.cols+s;this.slide(o)},onClickBoard(){this.$el.focus()},onResize(){const i=this.$el.offsetWidth,t=this.$el.offsetHeight;this.autoResize?(this.internalWidth=i,this.internalHeight=t):(this.internalWidth=this.width,this.internalHeight=this.height),this.isImage&&this.$nextTick(this._loadImageToCanvas.bind(this)),this.updateBlockPositions(!0)},onKeyUp(i){const t=this.board.blankpos,s=this.blocks.length;switch(i.keyCode){case 37:t+1<s&&this.slide(t+1);break;case 38:t+this.cols<s&&this.slide(t+this.cols);break;case 39:t-1>=0&&this.slide(t-1);break;case 40:t-this.cols>=0&&this.slide(t-this.cols)}}}},j={key:0,class:"puzzle-message"},O=["width","height"],X=["src"],Y=["muted","src","width","height"],D=["src","type"];function K(i,t,s,e,o,n){return u(),f("div",{class:"puzzle-board",tabindex:"-1",onKeyup:t[8]||(t[8]=c((...h)=>n.onKeyUp&&n.onKeyUp(...h),["prevent"])),onClick:t[9]||(t[9]=(...h)=>n.onClickBoard&&n.onClickBoard(...h))},[o.isTouchNeeded?(u(),f("div",j,"Touch to start")):P("",!0),C("canvas",{ref:"puzzle-canvas1",class:"puzzle-canvas",style:{visibility:"hidden"},onClick:t[0]||(t[0]=c(()=>{},["prevent"])),onMousedown:t[1]||(t[1]=c(()=>{},["prevent"])),onMouseup:t[2]||(t[2]=c((...h)=>n.onClick&&n.onClick(...h),["prevent"])),onTouchend:t[3]||(t[3]=c((...h)=>n.onTouchEnd&&n.onTouchEnd(...h),["prevent"])),width:o.internalWidth*2,height:o.internalHeight},null,40,O),C("canvas",{ref:"puzzle-canvas",class:"puzzle-canvas",onClick:t[4]||(t[4]=c(()=>{},["prevent"])),onMousedown:t[5]||(t[5]=c(()=>{},["prevent"])),onMouseup:t[6]||(t[6]=c((...h)=>n.onClick&&n.onClick(...h),["prevent"])),onTouchend:t[7]||(t[7]=c((...h)=>n.onTouchEnd&&n.onTouchEnd(...h),["prevent"])),style:_(n.canvasStyle),width:1024,height:512},null,36),n.isImage?(u(),f("img",{key:1,style:_(n.sourceStyle),src:s.src,ref:"sourceImg"},null,12,X)):(u(),f("video",{key:2,ref:"sourceImg",autoplay:"",loop:"",playsinline:"",muted:s.muted,src:s.src,style:_(n.sourceStyle),width:o.internalWidth,height:o.internalHeight},[(u(!0),f(E,null,W(s.sources,h=>(u(),f("source",{key:h.src,src:h.src,type:h.type},null,8,D))),128)),H(" No video ")],12,Y))],32)}const U=R(V,[["render",K],["__scopeId","data-v-56a9d915"]]),q={class:"puzzle-container"},Z=S({__name:"PuzzlePage",setup(i){const{puzzleOpenedAchieves:t,puzzleAchieves:s}=$(),e=I(()=>s.value.filter(m=>!t.value.includes(m))),o=I(()=>e.value[0]);console.log("firstNotOpenedAchievement",o.value);const n=x(512),h=x(512),a=!0,l=x(!1),r=()=>{},k=()=>{},v=()=>{},g=()=>{console.log("finish!")};return(m,w)=>(u(),f("div",q,[M(U,{autoResize:!0,showNumber:l.value,cols:3,rows:3,src:G(o),animation:a,width:n.value,height:h.value,onInit:r,onStart:k,onChange:v,onFinish:g},null,8,["showNumber","src","width","height"])]))}});export{Z as default};
